(function(e){"use strict";Number.prototype.map=function(e,t,n,r){return n+(r-n)*((this-e)/(t-e))},Number.prototype.limit=function(e,t){return Math.min(t,Math.max(e,this))},Number.prototype.round=function(e){return e=Math.pow(10,e||0),Math.round(this*e)/e},Number.prototype.floor=function(){return Math.floor(this)},Number.prototype.ceil=function(){return Math.ceil(this)},Number.prototype.toInt=function(){return this|0},Number.prototype.toRad=function(){return this/180*Math.PI},Number.prototype.toDeg=function(){return this*180/Math.PI},Array.prototype.erase=function(e){for(var t=this.length;t--;)this[t]===e&&this.splice(t,1);return this},Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]},Function.prototype.bind=Function.prototype.bind||function(e){var t=this;return function(){var n=Array.prototype.slice.call(arguments);return t.apply(e||null,n)}},e.ig={game:null,debug:null,version:"1.20",global:e,modules:{},resources:[],ready:!1,baked:!1,nocache:"",ua:{},prefix:e.ImpactPrefix||"",lib:"lib/",_current:null,_loadQueue:[],_waitForOnload:0,$:function(e){return e.charAt(0)=="#"?document.getElementById(e.substr(1)):document.getElementsByTagName(e)},$new:function(e){return document.createElement(e)},copy:function(e){if(!e||typeof e!="object"||e instanceof HTMLElement||e instanceof ig.Class)return e;if(e instanceof Array){var t=[];for(var n=0,r=e.length;n<r;n++)t[n]=ig.copy(e[n]);return t}var t={};for(var n in e)t[n]=ig.copy(e[n]);return t},merge:function(e,t){for(var n in t){var r=t[n];if(typeof r!="object"||r instanceof HTMLElement||r instanceof ig.Class)e[n]=r;else{if(!e[n]||typeof e[n]!="object")e[n]=r instanceof Array?[]:{};ig.merge(e[n],r)}}return e},ksort:function(e){if(!e||typeof e!="object")return[];var t=[],n=[];for(var r in e)t.push(r);t.sort();for(var r=0;r<t.length;r++)n.push(e[t[r]]);return n},module:function(e){if(ig._current)throw"Module '"+ig._current.name+"' defines nothing";if(ig.modules[e]&&ig.modules[e].body)throw"Module '"+e+"' is already defined";return ig._current={name:e,requires:[],loaded:!1,body:null},ig.modules[e]=ig._current,ig._loadQueue.push(ig._current),ig},requires:function(){return ig._current.requires=Array.prototype.slice.call(arguments),ig},defines:function(e){ig._current.body=e,ig._current=null,ig._initDOMReady()},addResource:function(e){ig.resources.push(e)},setNocache:function(e){ig.nocache=e?"?"+Date.now():""},log:function(){},assert:function(e,t){},show:function(e,t){},mark:function(e,t){},_loadScript:function(e,t){ig.modules[e]={name:e,requires:[],loaded:!1,body:null},ig._waitForOnload++;var n=ig.prefix+ig.lib+e.replace(/\./g,"/")+".js"+ig.nocache,r=ig.$new("script");r.type="text/javascript",r.src=n,r.onload=function(){ig._waitForOnload--,ig._execModules()},r.onerror=function(){throw"Failed to load module "+e+" at "+n+" "+"required from "+t},ig.$("head")[0].appendChild(r)},_execModules:function(){var e=!1;for(var t=0;t<ig._loadQueue.length;t++){var n=ig._loadQueue[t],r=!0;for(var i=0;i<n.requires.length;i++){var s=n.requires[i];ig.modules[s]?ig.modules[s].loaded||(r=!1):(r=!1,ig._loadScript(s,n.name))}r&&n.body&&(ig._loadQueue.splice(t,1),n.loaded=!0,n.body(),e=!0,t--)}if(e)ig._execModules();else if(!ig.baked&&ig._waitForOnload==0&&ig._loadQueue.length!=0){var o=[];for(var t=0;t<ig._loadQueue.length;t++){var u=[],a=ig._loadQueue[t].requires;for(var i=0;i<a.length;i++){var n=ig.modules[a[i]];(!n||!n.loaded)&&u.push(a[i])}o.push(ig._loadQueue[t].name+" (requires: "+u.join(", ")+")")}throw"Unresolved (circular?) dependencies. Most likely there's a name/path mismatch for one of the listed modules:\n"+o.join("\n")}},_DOMReady:function(){if(!ig.modules["dom.ready"].loaded){if(!document.body)return setTimeout(ig._DOMReady,13);ig.modules["dom.ready"].loaded=!0,ig._waitForOnload--,ig._execModules()}return 0},_boot:function(){document.location.href.match(/\?nocache/)&&ig.setNocache(!0),ig.ua.pixelRatio=e.devicePixelRatio||1,ig.ua.viewport={width:e.innerWidth,height:e.innerHeight},ig.ua.screen={width:e.screen.availWidth*ig.ua.pixelRatio,height:e.screen.availHeight*ig.ua.pixelRatio},ig.ua.iPhone=/iPhone/i.test(navigator.userAgent),ig.ua.iPhone4=ig.ua.iPhone&&ig.ua.pixelRatio==2,ig.ua.iPad=/iPad/i.test(navigator.userAgent),ig.ua.android=/android/i.test(navigator.userAgent),ig.ua.iOS=ig.ua.iPhone||ig.ua.iPad,ig.ua.mobile=ig.ua.iOS||ig.ua.android},_initDOMReady:function(){if(ig.modules["dom.ready"]){ig._execModules();return}ig._boot(),ig.modules["dom.ready"]={requires:[],loaded:!1,body:null},ig._waitForOnload++,document.readyState==="complete"?ig._DOMReady():(document.addEventListener("DOMContentLoaded",ig._DOMReady,!1),e.addEventListener("load",ig._DOMReady,!1))}};var t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!e.requestAnimationFrame;n++)e.requestAnimationFrame=e[t[n]+"RequestAnimationFrame"];if(e.requestAnimationFrame){var r=1,i={};e.ig.setAnimation=function(t,n){var s=r++;i[s]=!0;var o=function(){if(!i[s])return;e.requestAnimationFrame(o,n),t()};return e.requestAnimationFrame(o,n),s},e.ig.clearAnimation=function(e){delete i[e]}}else e.ig.setAnimation=function(t,n){return e.setInterval(t,1e3/60)},e.ig.clearAnimation=function(t){e.clearInterval(t)};var s=!1,o=/xyz/.test(function(){xyz})?/\bparent\b/:/.*/;e.ig.Class=function(){};var u=function(e){var t=this.prototype,n={};for(var r in e)typeof e[r]=="function"&&typeof t[r]=="function"&&o.test(e[r])?(n[r]=t[r],t[r]=function(e,t){return function(){var r=this.parent;this.parent=n[e];var i=t.apply(this,arguments);return this.parent=r,i}}(r,e[r])):t[r]=e[r]};e.ig.Class.extend=function(t){function a(){if(!s){if(this.staticInstantiate){var e=this.staticInstantiate.apply(this,arguments);if(e)return e}for(var t in this)typeof this[t]=="object"&&(this[t]=ig.copy(this[t]));this.init&&this.init.apply(this,arguments)}return this}var n=this.prototype;s=!0;var r=new this;s=!1;for(var i in t)typeof t[i]=="function"&&typeof n[i]=="function"&&o.test(t[i])?r[i]=function(e,t){return function(){var r=this.parent;this.parent=n[e];var i=t.apply(this,arguments);return this.parent=r,i}}(i,t[i]):r[i]=t[i];return a.prototype=r,a.constructor=a,a.extend=e.ig.Class.extend,a.inject=u,a}})(window),ig.Image=ig.Class.extend({data:null,width:0,height:0,loaded:!1,failed:!1,loadCallback:null,path:"",staticInstantiate:function(e){return ig.Image.cache[e]||null},init:function(e){this.path=e,this.load()},load:function(e){if(this.loaded){e&&e(this.path,!0);return}!this.loaded&&ig.ready?(this.loadCallback=e||null,this.data=new Image,this.data.onload=this.onload.bind(this),this.data.onerror=this.onerror.bind(this),this.data.src=ig.prefix+this.path+ig.nocache):ig.addResource(this),ig.Image.cache[this.path]=this},reload:function(){this.loaded=!1,this.data=new Image,this.data.onload=this.onload.bind(this),this.data.src=this.path+"?"+Date.now()},onload:function(e){this.width=this.data.width,this.height=this.data.height,this.loaded=!0,ig.system.scale!=1&&this.resize(ig.system.scale),this.loadCallback&&this.loadCallback(this.path,!0)},onerror:function(e){this.failed=!0,this.loadCallback&&this.loadCallback(this.path,!1)},resize:function(e){var t=this.width*e,n=this.height*e,r=ig.$new("canvas");r.width=this.width,r.height=this.height;var i=r.getContext("2d");i.drawImage(this.data,0,0,this.width,this.height,0,0,this.width,this.height);var s=i.getImageData(0,0,this.width,this.height),o=ig.$new("canvas");o.width=t,o.height=n;var u=o.getContext("2d"),a=u.getImageData(0,0,t,n);for(var f=0;f<n;f++)for(var l=0;l<t;l++){var c=(Math.floor(f/e)*this.width+Math.floor(l/e))*4,h=(f*t+l)*4;a.data[h]=s.data[c],a.data[h+1]=s.data[c+1],a.data[h+2]=s.data[c+2],a.data[h+3]=s.data[c+3]}u.putImageData(a,0,0),this.data=o},draw:function(e,t,n,r,i,s){if(!this.loaded)return;var o=ig.system.scale;n=n?n*o:0,r=r?r*o:0,i=(i?i:this.width)*o,s=(s?s:this.height)*o,ig.system.context.drawImage(this.data,n,r,i,s,ig.system.getDrawPos(e),ig.system.getDrawPos(t),i,s),ig.Image.drawCount++},drawTile:function(e,t,n,r,i,s,o){i=i?i:r;if(!this.loaded||r>this.width||i>this.height)return;var u=ig.system.scale,a=Math.floor(r*u),f=Math.floor(i*u),l=s?-1:1,c=o?-1:1;if(s||o)ig.system.context.save(),ig.system.context.scale(l,c);ig.system.context.drawImage(this.data,Math.floor(n*r)%this.width*u,Math.floor(n*r/this.width)*i*u,a,f,ig.system.getDrawPos(e)*l-(s?a:0),ig.system.getDrawPos(t)*c-(o?f:0),a,f),(s||o)&&ig.system.context.restore(),ig.Image.drawCount++}}),ig.Image.drawCount=0,ig.Image.cache={},ig.Image.reloadCache=function(){for(var e in ig.Image.cache)ig.Image.cache[e].reload()},ig.Font=ig.Image.extend({widthMap:[],indices:[],firstChar:32,alpha:1,letterSpacing:1,lineSpacing:0,onload:function(e){this._loadMetrics(this.data),this.parent(e)},widthForString:function(e){if(e.indexOf("\n")!==-1){var t=e.split("\n"),n=0;for(var r=0;r<t.length;r++)n=Math.max(n,this._widthForLine(t[r]));return n}return this._widthForLine(e)},_widthForLine:function(e){var t=0;for(var n=0;n<e.length;n++)t+=this.widthMap[e.charCodeAt(n)-this.firstChar]+this.letterSpacing;return t},heightForString:function(e){return e.split("\n").length*(this.height+this.lineSpacing)},draw:function(e,t,n,r){typeof e!="string"&&(e=e.toString());if(e.indexOf("\n")!==-1){var i=e.split("\n"),s=this.height+this.lineSpacing;for(var o=0;o<i.length;o++)this.draw(i[o],t,n+o*s,r);return}if(r==ig.Font.ALIGN.RIGHT||r==ig.Font.ALIGN.CENTER){var u=this._widthForLine(e);t-=r==ig.Font.ALIGN.CENTER?u/2:u}this.alpha!==1&&(ig.system.context.globalAlpha=this.alpha);for(var o=0;o<e.length;o++){var a=e.charCodeAt(o);t+=this._drawChar(a-this.firstChar,t,n)}this.alpha!==1&&(ig.system.context.globalAlpha=1),ig.Image.drawCount+=e.length},_drawChar:function(e,t,n){if(!this.loaded||e<0||e>=this.indices.length)return 0;var r=ig.system.scale,i=this.indices[e]*r,s=0,o=this.widthMap[e]*r,u=(this.height-2)*r;return ig.system.context.drawImage(this.data,i,s,o,u,ig.system.getDrawPos(t),ig.system.getDrawPos(n),o,u),this.widthMap[e]+this.letterSpacing},_loadMetrics:function(e){this.height=e.height-1,this.widthMap=[],this.indices=[];var t=ig.$new("canvas");t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var r=n.getImageData(0,e.height-1,e.width,1),i=0,s=0;for(var o=0;o<e.width;o++){var u=o*4+3;r.data[u]!=0?s++:r.data[u]==0&&s&&(this.widthMap.push(s),this.indices.push(o-s),i++,s=0)}this.widthMap.push(s),this.indices.push(o-s)}}),ig.Font.ALIGN={LEFT:0,RIGHT:1,CENTER:2},ig.SoundManager=ig.Class.extend({clips:{},volume:1,format:null,init:function(){var e=new Audio;for(var t=0;t<ig.Sound.use.length;t++){var n=ig.Sound.use[t];if(e.canPlayType(n.mime)){this.format=n;break}}this.format||(ig.Sound.enabled=!1)},load:function(e,t,n){var r=ig.prefix+e.replace(/[^\.]+$/,this.format.ext)+ig.nocache;if(this.clips[e]){if(t&&this.clips[e].length<ig.Sound.channels)for(var i=this.clips[e].length;i<ig.Sound.channels;i++){var s=new Audio(r);s.load(),this.clips[e].push(s)}return this.clips[e][0]}var o=new Audio(r);n&&(o.addEventListener("canplaythrough",function u(t){o.removeEventListener("canplaythrough",u,!1),n(e,!0,t)},!1),o.addEventListener("error",function(t){n(e,!1,t)},!1)),o.preload="auto",o.load(),this.clips[e]=[o];if(t)for(var i=1;i<ig.Sound.channels;i++){var s=new Audio(r);s.load(),this.clips[e].push(s)}return o},get:function(e){var t=this.clips[e];for(var n=0,r;r=t[n++];)if(r.paused||r.ended)return r.ended&&(r.currentTime=0),r;return t[0].pause(),t[0].currentTime=0,t[0]}}),ig.Music=ig.Class.extend({tracks:[],namedTracks:{},currentTrack:null,currentIndex:0,random:!1,_volume:1,_loop:!1,_fadeInterval:0,_fadeTimer:null,_endedCallbackBound:null,init:function(){this._endedCallbackBound=this._endedCallback.bind(this),Object.defineProperty?(Object.defineProperty(this,"volume",{get:this.getVolume.bind(this),set:this.setVolume.bind(this)}),Object.defineProperty(this,"loop",{get:this.getLooping.bind(this),set:this.setLooping.bind(this)})):this.__defineGetter__&&(this.__defineGetter__("volume",this.getVolume.bind(this)),this.__defineSetter__("volume",this.setVolume.bind(this)),this.__defineGetter__("loop",this.getLooping.bind(this)),this.__defineSetter__("loop",this.setLooping.bind(this)))},add:function(e,t){if(!ig.Sound.enabled)return;var n=e instanceof ig.Sound?e.path:e,r=ig.soundManager.load(n,!1);r.loop=this._loop,r.volume=this._volume,r.addEventListener("ended",this._endedCallbackBound,!1),this.tracks.push(r),t&&(this.namedTracks[t]=r),this.currentTrack||(this.currentTrack=r)},next:function(){if(!this.tracks.length)return;this.stop(),this.currentIndex=this.random?Math.floor(Math.random()*this.tracks.length):(this.currentIndex+1)%this.tracks.length,this.currentTrack=this.tracks[this.currentIndex],this.play()},pause:function(){if(!this.currentTrack)return;this.currentTrack.pause()},stop:function(){if(!this.currentTrack)return;this.currentTrack.pause(),this.currentTrack.currentTime=0},play:function(e){if(e&&this.namedTracks[e]){var t=this.namedTracks[e];t!=this.currentTrack&&(this.stop(),this.currentTrack=t)}else if(!this.currentTrack)return;this.currentTrack.play()},getLooping:function(){return this._loop},setLooping:function(e){this._loop=e;for(var t in this.tracks)this.tracks[t].loop=e},getVolume:function(){return this._volume},setVolume:function(e){this._volume=e.limit(0,1);for(var t in this.tracks)this.tracks[t].volume=this._volume},fadeOut:function(e){if(!this.currentTrack)return;clearInterval(this._fadeInterval),this.fadeTimer=new ig.Timer(e),this._fadeInterval=setInterval(this._fadeStep.bind(this),50)},_fadeStep:function(){var e=this.fadeTimer.delta().map(-this.fadeTimer.target,0,1,0).limit(0,1)*this._volume;e<=.01?(this.stop(),this.currentTrack.volume=this._volume,clearInterval(this._fadeInterval)):this.currentTrack.volume=e},_endedCallback:function(){this._loop?this.play():this.next()}}),ig.Sound=ig.Class.extend({path:"",volume:1,currentClip:null,multiChannel:!0,init:function(e,t){this.path=e,this.multiChannel=t!==!1,this.load()},load:function(e){if(!ig.Sound.enabled){e&&e(this.path,!0);return}ig.ready?ig.soundManager.load(this.path,this.multiChannel,e):ig.addResource(this)},play:function(){if(!ig.Sound.enabled)return;this.currentClip=ig.soundManager.get(this.path),this.currentClip.volume=ig.soundManager.volume*this.volume,this.currentClip.play()},stop:function(){this.currentClip&&(this.currentClip.pause(),this.currentClip.currentTime=0)}}),ig.Sound.FORMAT={MP3:{ext:"mp3",mime:"audio/mpeg"},M4A:{ext:"m4a",mime:"audio/mp4; codecs=mp4a"},OGG:{ext:"ogg",mime:"audio/ogg; codecs=vorbis"},WEBM:{ext:"webm",mime:"audio/webm; codecs=vorbis"},CAF:{ext:"caf",mime:"audio/x-caf"}},ig.Sound.use=[ig.Sound.FORMAT.OGG,ig.Sound.FORMAT.MP3],ig.Sound.channels=4,ig.Sound.enabled=!0,ig.Loader=ig.Class.extend({resources:[],gameClass:null,status:0,done:!1,_unloaded:[],_drawStatus:0,_intervalId:0,_loadCallbackBound:null,init:function(e,t){this.gameClass=e,this.resources=t,this._loadCallbackBound=this._loadCallback.bind(this);for(var n=0;n<this.resources.length;n++)this._unloaded.push(this.resources[n].path)},load:function(){ig.system.clear("#000");if(!this.resources.length){this.end();return}for(var e=0;e<this.resources.length;e++)this.loadResource(this.resources[e]);this._intervalId=setInterval(this.draw.bind(this),16)},loadResource:function(e){e.load(this._loadCallbackBound)},end:function(){if(this.done)return;this.done=!0,clearInterval(this._intervalId),ig.system.setGame(this.gameClass)},draw:function(){this._drawStatus+=(this.status-this._drawStatus)/5;var e=ig.system.scale,t=ig.system.width*.6,n=ig.system.height*.1,r=ig.system.width*.5-t/2,i=ig.system.height*.5-n/2;ig.system.context.fillStyle="#000",ig.system.context.fillRect(0,0,480,320),ig.system.context.fillStyle="#fff",ig.system.context.fillRect(r*e,i*e,t*e,n*e),ig.system.context.fillStyle="#000",ig.system.context.fillRect(r*e+e,i*e+e,t*e-e-e,n*e-e-e),ig.system.context.fillStyle="#fff",ig.system.context.fillRect(r*e,i*e,t*e*this._drawStatus,n*e)},_loadCallback:function(e,t){if(!t)throw"Failed to load resource: "+e;this._unloaded.erase(e),this.status=1-this._unloaded.length/this.resources.length,this._unloaded.length==0&&setTimeout(this.end.bind(this),250)}}),ig.Timer=ig.Class.extend({target:0,base:0,last:0,pausedAt:0,init:function(e){this.base=ig.Timer.time,this.last=ig.Timer.time,this.target=e||0},set:function(e){this.target=e||0,this.base=ig.Timer.time,this.pausedAt=0},reset:function(){this.base=ig.Timer.time,this.pausedAt=0},tick:function(){var e=ig.Timer.time-this.last;return this.last=ig.Timer.time,this.pausedAt?0:e},delta:function(){return(this.pausedAt||ig.Timer.time)-this.base-this.target},pause:function(){this.pausedAt||(this.pausedAt=ig.Timer.time)},unpause:function(){this.pausedAt&&(this.base+=ig.Timer.time-this.pausedAt,this.pausedAt=0)}}),ig.Timer._last=0,ig.Timer.time=0,ig.Timer.timeScale=1,ig.Timer.maxStep=.05,ig.Timer.step=function(){var e=Date.now(),t=(e-ig.Timer._last)/1e3;ig.Timer.time+=Math.min(t,ig.Timer.maxStep)*ig.Timer.timeScale,ig.Timer._last=e},ig.System=ig.Class.extend({fps:30,width:320,height:240,realWidth:320,realHeight:240,scale:1,tick:0,animationId:0,newGameClass:null,running:!1,delegate:null,clock:null,canvas:null,context:null,init:function(e,t,n,r,i){this.fps=t,this.clock=new ig.Timer,this.canvas=ig.$(e),this.resize(n,r,i),this.context=this.canvas.getContext("2d"),this.getDrawPos=ig.System.drawMode},resize:function(e,t,n){this.width=e,this.height=t,this.scale=n||this.scale,this.realWidth=this.width*this.scale,this.realHeight=this.height*this.scale,this.canvas.width=this.realWidth,this.canvas.height=this.realHeight},setGame:function(e){this.running?this.newGameClass=e:this.setGameNow(e)},setGameNow:function(e){ig.game=new e,ig.system.setDelegate(ig.game)},setDelegate:function(e){if(typeof e.run!="function")throw"System.setDelegate: No run() function in object";this.delegate=e,this.startRunLoop()},stopRunLoop:function(){ig.clearAnimation(this.animationId),this.running=!1},startRunLoop:function(){this.stopRunLoop(),this.animationId=ig.setAnimation(this.run.bind(this),this.canvas),this.running=!0},clear:function(e){this.context.fillStyle=e,this.context.fillRect(0,0,this.realWidth,this.realHeight)},run:function(){ig.Timer.step(),this.tick=this.clock.tick(),this.delegate.run(),ig.input.clearPressed(),this.newGameClass&&(this.setGameNow(this.newGameClass),this.newGameClass=null)},getDrawPos:null}),ig.System.DRAW={AUTHENTIC:function(e){return Math.round(e)*this.scale},SMOOTH:function(e){return Math.round(e*this.scale)},SUBPIXEL:function(e){return e*this.scale}},ig.System.drawMode=ig.System.DRAW.SMOOTH,ig.KEY={MOUSE1:-1,MOUSE2:-3,MWHEEL_UP:-4,MWHEEL_DOWN:-5,BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,_0:48,_1:49,_2:50,_3:51,_4:52,_5:53,_6:54,_7:55,_8:56,_9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190},ig.Input=ig.Class.extend({bindings:{},actions:{},presses:{},locks:{},delayedKeyup:{},isUsingMouse:!1,isUsingKeyboard:!1,isUsingAccelerometer:!1,mouse:{x:0,y:0},accel:{x:0,y:0,z:0},initMouse:function(){if(this.isUsingMouse)return;this.isUsingMouse=!0;var e=this.mousewheel.bind(this);ig.system.canvas.addEventListener("mousewheel",e,!1),ig.system.canvas.addEventListener("DOMMouseScroll",e,!1),ig.system.canvas.addEventListener("contextmenu",this.contextmenu.bind(this),!1),ig.system.canvas.addEventListener("mousedown",this.keydown.bind(this),!1),ig.system.canvas.addEventListener("mouseup",this.keyup.bind(this),!1),ig.system.canvas.addEventListener("mousemove",this.mousemove.bind(this),!1),ig.system.canvas.addEventListener("touchstart",this.keydown.bind(this),!1),ig.system.canvas.addEventListener("touchend",this.keyup.bind(this),!1),ig.system.canvas.addEventListener("touchmove",this.mousemove.bind(this),!1)},initKeyboard:function(){if(this.isUsingKeyboard)return;this.isUsingKeyboard=!0,window.addEventListener("keydown",this.keydown.bind(this),!1),window.addEventListener("keyup",this.keyup.bind(this),!1)},initAccelerometer:function(){if(this.isUsingAccelerometer)return;window.addEventListener("devicemotion",this.devicemotion.bind(this),!1)},mousewheel:function(e){var t=e.wheelDelta?e.wheelDelta:e.detail*-1,n=t>0?ig.KEY.MWHEEL_UP:ig.KEY.MWHEEL_DOWN,r=this.bindings[n];r&&(this.actions[r]=!0,this.presses[r]=!0,this.delayedKeyup[r]=!0,e.stopPropagation(),e.preventDefault())},mousemove:function(e){var t=ig.system.canvas,n={left:0,top:0};while(t!=null)n.left+=t.offsetLeft,n.top+=t.offsetTop,t=t.offsetParent;var r=e.pageX,i=e.pageY;e.touches&&(r=e.touches[0].clientX,i=e.touches[0].clientY),this.mouse.x=(r-n.left)/ig.system.scale,this.mouse.y=(i-n.top)/ig.system.scale},contextmenu:function(e){this.bindings[ig.KEY.MOUSE2]&&(e.stopPropagation(),e.preventDefault())},keydown:function(e){if(e.target.type=="text")return;var t=e.type=="keydown"?e.keyCode:e.button==2?ig.KEY.MOUSE2:ig.KEY.MOUSE1;(e.type=="touchstart"||e.type=="mousedown")&&this.mousemove(e);var n=this.bindings[t];n&&(this.actions[n]=!0,this.locks[n]||(this.presses[n]=!0,this.locks[n]=!0),e.stopPropagation(),e.preventDefault())},keyup:function(e){if(e.target.type=="text")return;var t=e.type=="keyup"?e.keyCode:e.button==2?ig.KEY.MOUSE2:ig.KEY.MOUSE1,n=this.bindings[t];n&&(this.delayedKeyup[n]=!0,e.stopPropagation(),e.preventDefault())},devicemotion:function(e){this.accel=e.accelerationIncludingGravity},bind:function(e,t){e<0?this.initMouse():e>0&&this.initKeyboard(),this.bindings[e]=t},bindTouch:function(e,t){var n=ig.$(e),r=this;n.addEventListener("touchstart",function(e){r.touchStart(e,t)},!1),n.addEventListener("touchend",function(e){r.touchEnd(e,t)},!1)},unbind:function(e){var t=this.bindings[e];this.delayedKeyup[t]=!0,this.bindings[e]=null},unbindAll:function(){this.bindings={},this.actions={},this.presses={},this.locks={},this.delayedKeyup={}},state:function(e){return this.actions[e]},pressed:function(e){return this.presses[e]},released:function(e){return this.delayedKeyup[e]},clearPressed:function(){for(var e in this.delayedKeyup)this.actions[e]=!1,this.locks[e]=!1;this.delayedKeyup={},this.presses={}},touchStart:function(e,t){return this.actions[t]=!0,this.presses[t]=!0,e.stopPropagation(),e.preventDefault(),!1},touchEnd:function(e,t){return this.delayedKeyup[t]=!0,e.stopPropagation(),e.preventDefault(),!1}}),ig.main=function(e,t,n,r,i,s,o){ig.system=new ig.System(e,n,r,i,s||1),ig.input=new ig.Input,ig.soundManager=new ig.SoundManager,ig.music=new ig.Music,ig.ready=!0;var u=new(o||ig.Loader)(t,ig.resources);u.load()},ig.AnimationSheet=ig.Class.extend({width:8,height:8,image:null,init:function(e,t,n){this.width=t,this.height=n,this.image=new ig.Image(e)}}),ig.Animation=ig.Class.extend({sheet:null,timer:null,sequence:[],flip:{x:!1,y:!1},pivot:{x:0,y:0},frame:0,tile:0,loopCount:0,alpha:1,angle:0,init:function(e,t,n,r){this.sheet=e,this.pivot={x:e.width/2,y:e.height/2},this.timer=new ig.Timer,this.frameTime=t,this.sequence=n,this.stop=!!r,this.tile=this.sequence[0]},rewind:function(){return this.timer.reset(),this.loopCount=0,this.tile=this.sequence[0],this},gotoFrame:function(e){this.timer.set(this.frameTime*-e),this.update()},gotoRandomFrame:function(){this.gotoFrame(Math.floor(Math.random()*this.sequence.length))},update:function(){var e=Math.floor(this.timer.delta()/this.frameTime);this.loopCount=Math.floor(e/this.sequence.length),this.stop&&this.loopCount>0?this.frame=this.sequence.length-1:this.frame=e%this.sequence.length,this.tile=this.sequence[this.frame]},draw:function(e,t){var n=Math.max(this.sheet.width,this.sheet.height);if(e>ig.system.width||t>ig.system.height||e+n<0||t+n<0)return;this.alpha!=1&&(ig.system.context.globalAlpha=this.alpha),this.angle==0?this.sheet.image.drawTile(e,t,this.tile,this.sheet.width,this.sheet.height,this.flip.x,this.flip.y):(ig.system.context.save(),ig.system.context.translate(ig.system.getDrawPos(e+this.pivot.x),ig.system.getDrawPos(t+this.pivot.y)),ig.system.context.rotate(this.angle),this.sheet.image.drawTile(-this.pivot.x,-this.pivot.y,this.tile,this.sheet.width,this.sheet.height,this.flip.x,this.flip.y),ig.system.context.restore()),this.alpha!=1&&(ig.system.context.globalAlpha=1)}}),ig.Entity=ig.Class.extend({id:0,settings:{},size:{x:16,y:16},offset:{x:0,y:0},pos:{x:0,y:0},last:{x:0,y:0},vel:{x:0,y:0},accel:{x:0,y:0},friction:{x:0,y:0},maxVel:{x:100,y:100},zIndex:0,gravityFactor:1,standing:!1,bounciness:0,minBounceVelocity:40,anims:{},animSheet:null,currentAnim:null,health:10,type:0,checkAgainst:0,collides:0,_killed:!1,slopeStanding:{min:44..toRad(),max:136..toRad()},init:function(e,t,n){this.id=++ig.Entity._lastId,this.pos.x=e,this.pos.y=t,ig.merge(this,n)},addAnim:function(e,t,n,r){if(!this.animSheet)throw"No animSheet to add the animation "+e+" to.";var i=new ig.Animation(this.animSheet,t,n,r);return this.anims[e]=i,this.currentAnim||(this.currentAnim=i),i},update:function(){this.last.x=this.pos.x,this.last.y=this.pos.y,this.vel.y+=ig.game.gravity*ig.system.tick*this.gravityFactor,this.vel.x=this.getNewVelocity(this.vel.x,this.accel.x,this.friction.x,this.maxVel.x),this.vel.y=this.getNewVelocity(this.vel.y,this.accel.y,this.friction.y,this.maxVel.y);var e=this.vel.x*ig.system.tick,t=this.vel.y*ig.system.tick,n=ig.game.collisionMap.trace(this.pos.x,this.pos.y,e,t,this.size.x,this.size.y);this.handleMovementTrace(n),this.currentAnim&&this.currentAnim.update()},getNewVelocity:function(e,t,n,r){if(t)return(e+t*ig.system.tick).limit(-r,r);if(n){var i=n*ig.system.tick;return e-i>0?e-i:e+i<0?e+i:0}return e.limit(-r,r)},handleMovementTrace:function(e){this.standing=!1,e.collision.y&&(this.bounciness>0&&Math.abs(this.vel.y)>this.minBounceVelocity?this.vel.y*=-this.bounciness:(this.vel.y>0&&(this.standing=!0),this.vel.y=0)),e.collision.x&&(this.bounciness>0&&Math.abs(this.vel.x)>this.minBounceVelocity?this.vel.x*=-this.bounciness:this.vel.x=0);if(e.collision.slope){var t=e.collision.slope;if(this.bounciness>0){var n=this.vel.x*t.nx+this.vel.y*t.ny;this.vel.x=(this.vel.x-t.nx*n*2)*this.bounciness,this.vel.y=(this.vel.y-t.ny*n*2)*this.bounciness}else{var r=t.x*t.x+t.y*t.y,i=(this.vel.x*t.x+this.vel.y*t.y)/r;this.vel.x=t.x*i,this.vel.y=t.y*i;var s=Math.atan2(t.x,t.y);s>this.slopeStanding.min&&s<this.slopeStanding.max&&(this.standing=!0)}}this.pos=e.pos},draw:function(){this.currentAnim&&this.currentAnim.draw(this.pos.x-this.offset.x-ig.game._rscreen.x,this.pos.y-this.offset.y-ig.game._rscreen.y)},kill:function(){ig.game.removeEntity(this)},receiveDamage:function(e,t){this.health-=e,this.health<=0&&this.kill()},touches:function(e){return!(this.pos.x>=e.pos.x+e.size.x||this.pos.x+this.size.x<=e.pos.x||this.pos.y>=e.pos.y+e.size.y||this.pos.y+this.size.y<=e.pos.y)},distanceTo:function(e){var t=this.pos.x+this.size.x/2-(e.pos.x+e.size.x/2),n=this.pos.y+this.size.y/2-(e.pos.y+e.size.y/2);return Math.sqrt(t*t+n*n)},angleTo:function(e){return Math.atan2(e.pos.y+e.size.y/2-(this.pos.y+this.size.y/2),e.pos.x+e.size.x/2-(this.pos.x+this.size.x/2))},check:function(e){},collideWith:function(e,t){},ready:function(){}}),ig.Entity._lastId=0,ig.Entity.COLLIDES={NEVER:0,LITE:1,PASSIVE:2,ACTIVE:4,FIXED:8},ig.Entity.TYPE={NONE:0,A:1,B:2,BOTH:3},ig.Entity.checkPair=function(e,t){e.checkAgainst&t.type&&e.check(t),t.checkAgainst&e.type&&t.check(e),e.collides&&t.collides&&e.collides+t.collides>ig.Entity.COLLIDES.ACTIVE&&ig.Entity.solveCollision(e,t)},ig.Entity.solveCollision=function(e,t){var n=null;if(e.collides==ig.Entity.COLLIDES.LITE||t.collides==ig.Entity.COLLIDES.FIXED)n=e;else if(t.collides==ig.Entity.COLLIDES.LITE||e.collides==ig.Entity.COLLIDES.FIXED)n=t;e.last.x+e.size.x>t.last.x&&e.last.x<t.last.x+t.size.x?(e.last.y<t.last.y?ig.Entity.seperateOnYAxis(e,t,n):ig.Entity.seperateOnYAxis(t,e,n),e.collideWith(t,"y"),t.collideWith(e,"y")):e.last.y+e.size.y>t.last.y&&e.last.y<t.last.y+t.size.y&&(e.last.x<t.last.x?ig.Entity.seperateOnXAxis(e,t,n):ig.Entity.seperateOnXAxis(t,e,n),e.collideWith(t,"x"),t.collideWith(e,"x"))},ig.Entity.seperateOnXAxis=function(e,t,n){var r=e.pos.x+e.size.x-t.pos.x;if(n){var i=e===n?t:e;n.vel.x=-n.vel.x*n.bounciness+i.vel.x;var s=ig.game.collisionMap.trace(n.pos.x,n.pos.y,n==e?-r:r,0,n.size.x,n.size.y);n.pos.x=s.pos.x}else{var o=(e.vel.x-t.vel.x)/2;e.vel.x=-o,t.vel.x=o;var u=ig.game.collisionMap.trace(e.pos.x,e.pos.y,-r/2,0,e.size.x,e.size.y);e.pos.x=Math.floor(u.pos.x);var a=ig.game.collisionMap.trace(t.pos.x,t.pos.y,r/2,0,t.size.x,t.size.y);t.pos.x=Math.ceil(a.pos.x)}},ig.Entity.seperateOnYAxis=function(e,t,n){var r=e.pos.y+e.size.y-t.pos.y;if(n){var i=e===n?t:e;n.vel.y=-n.vel.y*n.bounciness+i.vel.y;var s=0;n==e&&Math.abs(n.vel.y-i.vel.y)<n.minBounceVelocity&&(n.standing=!0,s=i.vel.x*ig.system.tick);var o=ig.game.collisionMap.trace(n.pos.x,n.pos.y,s,n==e?-r:r,n.size.x,n.size.y);n.pos.y=o.pos.y,n.pos.x=o.pos.x}else if(ig.game.gravity&&(t.standing||e.vel.y>0)){var u=ig.game.collisionMap.trace(e.pos.x,e.pos.y,0,-(e.pos.y+e.size.y-t.pos.y),e.size.x,e.size.y);e.pos.y=u.pos.y,e.bounciness>0&&e.vel.y>e.minBounceVelocity?e.vel.y*=-e.bounciness:(e.standing=!0,e.vel.y=0)}else{var a=(e.vel.y-t.vel.y)/2;e.vel.y=-a,t.vel.y=a;var s=t.vel.x*ig.system.tick,u=ig.game.collisionMap.trace(e.pos.x,e.pos.y,s,-r/2,e.size.x,e.size.y);e.pos.y=u.pos.y;var f=ig.game.collisionMap.trace(t.pos.x,t.pos.y,0,r/2,t.size.x,t.size.y);t.pos.y=f.pos.y}},ig.Map=ig.Class.extend({tilesize:8,width:1,height:1,data:[[]],name:null,init:function(e,t){this.tilesize=e,this.data=t,this.height=t.length,this.width=t[0].length},getTile:function(e,t){var n=Math.floor(e/this.tilesize),r=Math.floor(t/this.tilesize);return n>=0&&n<this.width&&r>=0&&r<this.height?this.data[r][n]:0},setTile:function(e,t,n){var r=Math.floor(e/this.tilesize),i=Math.floor(t/this.tilesize);r>=0&&r<this.width&&i>=0&&i<this.height&&(this.data[i][r]=n)}}),ig.CollisionMap=ig.Map.extend({lastSlope:1,tiledef:null,init:function(e,t,n){this.parent(e,t),this.tiledef=n||ig.CollisionMap.defaultTileDef;for(var r in this.tiledef)r|0>this.lastSlope&&(this.lastSlope=r|0)},trace:function(e,t,n,r,i,s){var o={collision:{x:!1,y:!1,slope:!1},pos:{x:e,y:t},tile:{x:0,y:0}},u=Math.ceil(Math.max(Math.abs(n),Math.abs(r))/this.tilesize);if(u>1){var a=n/u,f=r/u;for(var l=0;l<u&&(a||f);l++){this._traceStep(o,e,t,a,f,i,s,n,r,l),e=o.pos.x,t=o.pos.y,o.collision.x&&(a=0,n=0),o.collision.y&&(f=0,r=0);if(o.collision.slope)break}}else this._traceStep(o,e,t,n,r,i,s,n,r,0);return o},_traceStep:function(e,t,n,r,i,s,o,u,a,f){e.pos.x+=r,e.pos.y+=i;var l=0;if(r){var c=r>0?s:0,h=r<0?this.tilesize:0,p=Math.max(Math.floor(n/this.tilesize),0),d=Math.min(Math.ceil((n+o)/this.tilesize),this.height),v=Math.floor((e.pos.x+c)/this.tilesize),m=Math.floor((t+c)/this.tilesize);if(f>0||v==m||m<0||m>=this.width)m=-1;if(v>=0&&v<this.width)for(var g=p;g<d;g++){if(m!=-1){l=this.data[g][m];if(l>1&&l<=this.lastSlope&&this._checkTileDef(e,l,t,n,u,a,s,o,m,g))break}l=this.data[g][v];if(l==1||l>this.lastSlope||l>1&&this._checkTileDef(e,l,t,n,u,a,s,o,v,g)){if(l>1&&l<=this.lastSlope&&e.collision.slope)break;e.collision.x=!0,e.tile.x=l,t=e.pos.x=v*this.tilesize-c+h,u=0;break}}}if(i){var y=i>0?o:0,b=i<0?this.tilesize:0,w=Math.max(Math.floor(e.pos.x/this.tilesize),0),E=Math.min(Math.ceil((e.pos.x+s)/this.tilesize),this.width),g=Math.floor((e.pos.y+y)/this.tilesize),S=Math.floor((n+y)/this.tilesize);if(f>0||g==S||S<0||S>=this.height)S=-1;if(g>=0&&g<this.height)for(var v=w;v<E;v++){if(S!=-1){l=this.data[S][v];if(l>1&&l<=this.lastSlope&&this._checkTileDef(e,l,t,n,u,a,s,o,v,S))break}l=this.data[g][v];if(l==1||l>this.lastSlope||l>1&&this._checkTileDef(e,l,t,n,u,a,s,o,v,g)){if(l>1&&l<=this.lastSlope&&e.collision.slope)break;e.collision.y=!0,e.tile.y=l,e.pos.y=g*this.tilesize-y+b;break}}}},_checkTileDef:function(e,t,n,r,i,s,o,u,a,f){var l=this.tiledef[t];if(!l)return!1;var c=(a+l[0])*this.tilesize,h=(f+l[1])*this.tilesize,p=(l[2]-l[0])*this.tilesize,d=(l[3]-l[1])*this.tilesize,v=l[4],m=n+i+(d<0?o:0)-c,g=r+s+(p>0?u:0)-h;if(p*g-d*m>0){if(i*-d+s*p<0)return v;var y=Math.sqrt(p*p+d*d),b=d/y,w=-p/y,E=m*b+g*w,S=b*E,x=w*E;return S*S+x*x>=i*i+s*s?v||p*(g-s)-d*(m-i)<.5:(e.pos.x=n+i-S,e.pos.y=r+s-x,e.collision.slope={x:p,y:d,nx:b,ny:w},!0)}return!1}});var H=.5,N=1/3,M=2/3,SOLID=!0,NON_SOLID=!1;ig.CollisionMap.defaultTileDef={5:[0,1,1,M,SOLID],6:[0,M,1,N,SOLID],7:[0,N,1,0,SOLID],3:[0,1,1,H,SOLID],4:[0,H,1,0,SOLID],2:[0,1,1,0,SOLID],10:[H,1,1,0,SOLID],21:[0,1,H
,0,SOLID],32:[M,1,1,0,SOLID],43:[N,1,M,0,SOLID],54:[0,1,N,0,SOLID],27:[0,0,1,N,SOLID],28:[0,N,1,M,SOLID],29:[0,M,1,1,SOLID],25:[0,0,1,H,SOLID],26:[0,H,1,1,SOLID],24:[0,0,1,1,SOLID],11:[0,0,H,1,SOLID],22:[H,0,1,1,SOLID],33:[0,0,N,1,SOLID],44:[N,0,M,1,SOLID],55:[M,0,1,1,SOLID],16:[1,N,0,0,SOLID],17:[1,M,0,N,SOLID],18:[1,1,0,M,SOLID],14:[1,H,0,0,SOLID],15:[1,1,0,H,SOLID],13:[1,1,0,0,SOLID],8:[H,1,0,0,SOLID],19:[1,1,H,0,SOLID],30:[N,1,0,0,SOLID],41:[M,1,N,0,SOLID],52:[1,1,M,0,SOLID],38:[1,M,0,1,SOLID],39:[1,N,0,M,SOLID],40:[1,0,0,N,SOLID],36:[1,H,0,1,SOLID],37:[1,0,0,H,SOLID],35:[1,0,0,1,SOLID],9:[1,0,H,1,SOLID],20:[H,0,0,1,SOLID],31:[1,0,M,1,SOLID],42:[M,0,N,1,SOLID],53:[N,0,0,1,SOLID],12:[0,0,1,0,NON_SOLID],23:[1,1,0,1,NON_SOLID],34:[1,0,1,1,NON_SOLID],45:[0,1,0,0,NON_SOLID]},ig.CollisionMap.staticNoCollision={trace:function(e,t,n,r){return{collision:{x:!1,y:!1,slope:!1},pos:{x:e+n,y:t+r},tile:{x:0,y:0}}}},ig.BackgroundMap=ig.Map.extend({tiles:null,scroll:{x:0,y:0},distance:1,repeat:!1,tilesetName:"",foreground:!1,enabled:!0,preRender:!1,preRenderedChunks:null,chunkSize:512,debugChunks:!1,anims:{},init:function(e,t,n){this.parent(e,t),this.setTileset(n)},setTileset:function(e){this.tilesetName=e instanceof ig.Image?e.path:e,this.tiles=new ig.Image(this.tilesetName),this.preRenderedChunks=null},setScreenPos:function(e,t){this.scroll.x=e/this.distance,this.scroll.y=t/this.distance},preRenderMapToChunks:function(){var e=this.width*this.tilesize*ig.system.scale,t=this.height*this.tilesize*ig.system.scale,n=Math.ceil(e/this.chunkSize),r=Math.ceil(t/this.chunkSize);this.preRenderedChunks=[];for(var i=0;i<r;i++){this.preRenderedChunks[i]=[];for(var s=0;s<n;s++){var o=s==n-1?e-s*this.chunkSize:this.chunkSize,u=i==r-1?t-i*this.chunkSize:this.chunkSize;this.preRenderedChunks[i][s]=this.preRenderChunk(s,i,o,u)}}},preRenderChunk:function(e,t,n,r){var i=n/this.tilesize/ig.system.scale+1,s=r/this.tilesize/ig.system.scale+1,o=e*this.chunkSize/ig.system.scale%this.tilesize,u=t*this.chunkSize/ig.system.scale%this.tilesize,a=Math.floor(e*this.chunkSize/this.tilesize/ig.system.scale),f=Math.floor(t*this.chunkSize/this.tilesize/ig.system.scale),l=ig.$new("canvas");l.width=n,l.height=r;var c=ig.system.context;ig.system.context=l.getContext("2d");for(var h=0;h<i;h++)for(var p=0;p<s;p++)if(h+a<this.width&&p+f<this.height){var d=this.data[p+f][h+a];d&&this.tiles.drawTile(h*this.tilesize-o,p*this.tilesize-u,d-1,this.tilesize)}return ig.system.context=c,l},draw:function(){if(!this.tiles.loaded||!this.enabled)return;this.preRender?this.drawPreRendered():this.drawTiled()},drawPreRendered:function(){this.preRenderedChunks||this.preRenderMapToChunks();var e=ig.system.getDrawPos(this.scroll.x),t=ig.system.getDrawPos(this.scroll.y);this.repeat&&(e%=this.width*this.tilesize*ig.system.scale,t%=this.height*this.tilesize*ig.system.scale);var n=Math.max(Math.floor(e/this.chunkSize),0),r=Math.max(Math.floor(t/this.chunkSize),0),i=Math.ceil((e+ig.system.realWidth)/this.chunkSize),s=Math.ceil((t+ig.system.realHeight)/this.chunkSize),o=this.preRenderedChunks[0].length,u=this.preRenderedChunks.length;this.repeat||(i=Math.min(i,o),s=Math.min(s,u));var a=0;for(var f=r;f<s;f++){var l=0;for(var c=n;c<i;c++){var h=this.preRenderedChunks[f%u][c%o],p=-e+c*this.chunkSize-l,d=-t+f*this.chunkSize-a;ig.system.context.drawImage(h,p,d),ig.Image.drawCount++,this.debugChunks&&(ig.system.context.strokeStyle="#f0f",ig.system.context.strokeRect(p,d,this.chunkSize,this.chunkSize)),this.repeat&&h.width<this.chunkSize&&p+h.width<ig.system.realWidth&&(l=this.chunkSize-h.width,i++)}this.repeat&&h.height<this.chunkSize&&d+h.height<ig.system.realHeight&&(a=this.chunkSize-h.height,s++)}},drawTiled:function(){var e=0,t=null,n=(this.scroll.x/this.tilesize).toInt(),r=(this.scroll.y/this.tilesize).toInt(),i=this.scroll.x%this.tilesize,s=this.scroll.y%this.tilesize,o=-i-this.tilesize,u=-s-this.tilesize,a=ig.system.width+this.tilesize-i,f=ig.system.height+this.tilesize-s;for(var l=-1,c=u;c<f;l++,c+=this.tilesize){var h=l+r;if(h>=this.height||h<0){if(!this.repeat)continue;h=h>0?h%this.height:(h+1)%this.height+this.height-1}for(var p=-1,d=o;d<a;p++,d+=this.tilesize){var v=p+n;if(v>=this.width||v<0){if(!this.repeat)continue;v=v>0?v%this.width:(v+1)%this.width+this.width-1}if(e=this.data[h][v])(t=this.anims[e-1])?t.draw(d,c):this.tiles.drawTile(d,c,e-1,this.tilesize)}}}}),ig.Game=ig.Class.extend({clearColor:"#000000",gravity:0,screen:{x:0,y:0},_rscreen:{x:0,y:0},entities:[],namedEntities:{},collisionMap:ig.CollisionMap.staticNoCollision,backgroundMaps:[],backgroundAnims:{},autoSort:!1,sortBy:null,cellSize:64,_deferredKill:[],_levelToLoad:null,_doSortEntities:!1,staticInstantiate:function(){return this.sortBy=this.sortBy||ig.Game.SORT.Z_INDEX,ig.game=this,null},loadLevel:function(e){this.screen={x:0,y:0},this.entities=[],this.namedEntities={};for(var t=0;t<e.entities.length;t++){var n=e.entities[t];this.spawnEntity(n.type,n.x,n.y,n.settings)}this.sortEntities(),this.collisionMap=ig.CollisionMap.staticNoCollision,this.backgroundMaps=[];for(var t=0;t<e.layer.length;t++){var r=e.layer[t];if(r.name=="collision")this.collisionMap=new ig.CollisionMap(r.tilesize,r.data);else{var i=new ig.BackgroundMap(r.tilesize,r.data,r.tilesetName);i.anims=this.backgroundAnims[r.tilesetName]||{},i.repeat=r.repeat,i.distance=r.distance,i.foreground=!!r.foreground,i.preRender=!!r.preRender,i.name=r.name,this.backgroundMaps.push(i)}}for(var t=0;t<this.entities.length;t++)this.entities[t].ready()},loadLevelDeferred:function(e){this._levelToLoad=e},getMapByName:function(e){if(e=="collision")return this.collisionMap;for(var t=0;t<this.backgroundMaps.length;t++)if(this.backgroundMaps[t].name==e)return this.backgroundMaps[t];return null},getEntityByName:function(e){return this.namedEntities[e]},getEntitiesByType:function(e){var t=typeof e=="string"?ig.global[e]:e,n=[];for(var r=0;r<this.entities.length;r++){var i=this.entities[r];i instanceof t&&!i._killed&&n.push(i)}return n},spawnEntity:function(e,t,n,r){var i=typeof e=="string"?ig.global[e]:e;if(!i)throw"Can't spawn entity of type "+e;var s=new i(t,n,r||{});return this.entities.push(s),s.name&&(this.namedEntities[s.name]=s),s},sortEntities:function(){this.entities.sort(this.sortBy)},sortEntitiesDeferred:function(){this._doSortEntities=!0},removeEntity:function(e){e.name&&delete this.namedEntities[e.name],e._killed=!0,e.type=ig.Entity.TYPE.NONE,e.checkAgainst=ig.Entity.TYPE.NONE,e.collides=ig.Entity.COLLIDES.NEVER,this._deferredKill.push(e)},run:function(){this.update(),this.draw()},update:function(){this._levelToLoad&&(this.loadLevel(this._levelToLoad),this._levelToLoad=null);if(this._doSortEntities||this.autoSort)this.sortEntities(),this._doSortEntities=!1;this.updateEntities(),this.checkEntities();for(var e=0;e<this._deferredKill.length;e++)this.entities.erase(this._deferredKill[e]);this._deferredKill=[];for(var t in this.backgroundAnims){var n=this.backgroundAnims[t];for(var r in n)n[r].update()}},updateEntities:function(){for(var e=0;e<this.entities.length;e++){var t=this.entities[e];t._killed||t.update()}},draw:function(){this.clearColor&&ig.system.clear(this.clearColor),this._rscreen.x=ig.system.getDrawPos(this.screen.x)/ig.system.scale,this._rscreen.y=ig.system.getDrawPos(this.screen.y)/ig.system.scale;var e;for(e=0;e<this.backgroundMaps.length;e++){var t=this.backgroundMaps[e];if(t.foreground)break;t.setScreenPos(this.screen.x,this.screen.y),t.draw()}this.drawEntities();for(e;e<this.backgroundMaps.length;e++){var t=this.backgroundMaps[e];t.setScreenPos(this.screen.x,this.screen.y),t.draw()}},drawEntities:function(){for(var e=0;e<this.entities.length;e++)this.entities[e].draw()},checkEntities:function(){var e={};for(var t=0;t<this.entities.length;t++){var n=this.entities[t];if(n.type==ig.Entity.TYPE.NONE&&n.checkAgainst==ig.Entity.TYPE.NONE&&n.collides==ig.Entity.COLLIDES.NEVER)continue;var r={},i=Math.floor(n.pos.x/this.cellSize),s=Math.floor(n.pos.y/this.cellSize),o=Math.floor((n.pos.x+n.size.x)/this.cellSize)+1,u=Math.floor((n.pos.y+n.size.y)/this.cellSize)+1;for(var a=i;a<o;a++)for(var f=s;f<u;f++)if(!e[a])e[a]={},e[a][f]=[n];else if(!e[a][f])e[a][f]=[n];else{var l=e[a][f];for(var c=0;c<l.length;c++)n.touches(l[c])&&!r[l[c].id]&&(r[l[c].id]=!0,ig.Entity.checkPair(n,l[c]));l.push(n)}}}}),ig.Game.SORT={Z_INDEX:function(e,t){return e.zIndex-t.zIndex},POS_X:function(e,t){return e.pos.x+e.size.x-(t.pos.x+t.size.x)},POS_Y:function(e,t){return e.pos.y+e.size.y-(t.pos.y+t.size.y)}};